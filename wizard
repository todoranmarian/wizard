#!/usr/bin/env bash

WIZARD_VERSION="1.0.0"

# Resolve installation directory
WIZARD_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WIZARD_LIB="$WIZARD_HOME/lib"

# Load shared library
source "$WIZARD_LIB/wizard-common"

log() {
  echo "[wizard] $1"
}

# -----------------------------
# HELP SYSTEM
# -----------------------------

show_help() {
  cat <<EOF
Wizard â€” your developer command spellbook

Usage:
  wizard <command> [args]

Commands:
  summon <target> [path]     Summon an IDE or tool at the given path
  configure                  Run interactive configuration wizard
  config list                Show current IDE/tool configuration
  upgrade                    Upgrade Wizard to the latest version
  reinstall                  Reinstall Wizard (keeps config)
  doctor                     Run diagnostics and check configuration
  self-update                Update Wizard to the latest version
  version                    Show Wizard version

Examples:
  wizard summon idea .
  wizard summon rider ~/projects/app
  wizard summon vs path/to/solution

  wizard configure
  wizard config list
  wizard upgrade
  wizard reinstall
  wizard doctor
  wizard self-update

Run 'wizard help summon' for more details.
EOF
}

show_command_help() {
  case "$1" in
    summon)
      cat <<EOF
Usage:
  wizard summon <target> [path]

Targets:
  idea             IntelliJ IDEA
  rider            JetBrains Rider
  vs               Visual Studio / VS Code
  git-extensions   GitExtensions

Examples:
  wizard summon idea .
  wizard summon rider ~/projects/app
  wizard summon vs MySolution.sln
  wizard summon git-extensions
EOF
      ;;
    configure)
      cat <<EOF
Usage:
  wizard configure

Run an interactive configuration wizard to set paths for:

  - IntelliJ IDEA (idea)
  - JetBrains Rider (rider)
  - Visual Studio / VS Code (vs)
  - GitExtensions (gitext)

Existing values are shown in brackets.
Press ENTER to keep or skip a value.
EOF
      ;;
    *)
      log "No detailed help available for '$1'"
      ;;
  esac
}

# -----------------------------
# CONFIGURATION WIZARD
# -----------------------------

configure_field() {
  local key="$1"
  local label="$2"

  local current new
  current="$(wizard_config_get "$key")"

  echo "Path to $label ($key)"
  [[ -n "$current" ]] && echo "Current: $current"

  read -rp "> " new
  if [[ -n "$new" || -z "$current" ]]; then
    wizard_config_set "$key" "$new"
  fi
  echo
}

configure_interactive() {
  mkdir -p "$(dirname "$WIZARD_CONFIG")"

  echo "Wizard Configuration"
  echo "Press ENTER to keep the existing value or leave empty."
  echo

  configure_field "idea"   "IntelliJ IDEA"
  configure_field "rider"  "JetBrains Rider"
  configure_field "vs"     "Visual Studio / VS Code"
  configure_field "gitext" "GitExtensions"

  wizard_log "Configuration saved to $WIZARD_CONFIG"
}

# -----------------------------
# SUMMON DISPATCHER
# -----------------------------

dispatch_summon() {
  local target="$1"
  shift || true

  if [[ -z "$target" ]]; then
    wizard_fail "Missing summon target."
  fi

  local cmd="$WIZARD_HOME/summon-$target"

  if [[ ! -x "$cmd" ]]; then
    wizard_log "ERROR: Unknown summon target: $target"
    wizard_log "Known targets:"
    for f in "$WIZARD_HOME"/summon-*; do
      echo "  - $(basename "$f" | sed 's/summon-//')"
    done
    exit 1
  fi

  "$cmd" "$@"
}

# -----------------------------
# MAIN DISPATCHER
# -----------------------------

main() {
  local cmd="$1"
  shift || true

  case "$cmd" in
    ""|help)
      [[ -n "$1" ]] && show_command_help "$1" || show_help
      ;;
    version|-v|--version)
      echo "wizard $WIZARD_VERSION"
      ;;
    summon)
      dispatch_summon "$@"
      ;;
    configure)
      configure_interactive
      ;;
    config)
      case "$1" in
        list) wizard_config_list ;;
        *) wizard_fail "Usage: wizard config list" ;;
      esac
      ;;
    upgrade)
      bash "$WIZARD_HOME/upgrade.sh"
      ;;
    reinstall)
      bash "$WIZARD_HOME/reinstall.sh"
      ;;
    doctor)
      bash "$WIZARD_HOME/doctor"
      ;;
    self-update)
      bash "$WIZARD_HOME/self-update"
      ;;
    *)
      log "ERROR: Unknown command: $cmd"
      show_help
      exit 1
      ;;
  esac
}

main "$@"
