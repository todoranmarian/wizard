#!/usr/bin/env bash

WIZARD_VERSION="1.0.0"

# Resolve installation directory
WIZARD_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WIZARD_COMMANDS="$WIZARD_HOME"
WIZARD_LIB="$WIZARD_HOME/lib"

# Load shared library
source "$WIZARD_LIB/wizard-common"

log() {
  echo "[wizard] $1"
}

show_help() {
  cat <<EOF
Wizard â€” your developer command spellbook

Usage:
  wizard <command> [args]

Commands:
  summon <target> <path>     Summon an IDE at the given path
  configure                  Run interactive configuration wizard
  config list                Show current IDE configuration
  upgrade                    Upgrade Wizard to the latest version
  reinstall                  Reinstall Wizard (keeps config)
  version                    Show Wizard version
  help [command]             Show help for a command

Examples:
  wizard summon idea .
  wizard summon rider ~/projects/app
  wizard summon vs path/to/solution

  wizard configure
  wizard config list
  wizard upgrade
  wizard reinstall

Run 'wizard help summon' for more details.
EOF
}

show_command_help() {
  case "$1" in
    summon)
      cat <<EOF
Usage:
  wizard summon <target> <path>

Targets:
  idea      IntelliJ IDEA
  rider     JetBrains Rider
  vs        Visual Studio / VS Code

Examples:
  wizard summon idea .
  wizard summon rider ~/projects/app
  wizard summon vs MySolution.sln
EOF
      ;;
    configure)
      cat <<EOF
Usage:
  wizard configure

Run an interactive configuration wizard to set paths for:

  - IntelliJ IDEA (idea)
  - JetBrains Rider (rider)
  - Visual Studio / VS Code (vs)

Existing values are shown in brackets.
Press ENTER to keep or skip a value.
EOF
      ;;
    *)
      log "No detailed help available for '$1'"
      ;;
  esac
}

configure_interactive() {
  mkdir -p "$(dirname "$WIZARD_CONFIG")"

  echo "Wizard Configuration"
  echo "Press ENTER to keep the existing value or leave empty."
  echo

  local current new

  # IntelliJ IDEA
  current="$(wizard_config_get idea)"
  echo "Path to IntelliJ IDEA (idea)"
  [[ -n "$current" ]] && echo "Current: $current"
  read -rp "> " new
  if [[ -n "$new" || -z "$current" ]]; then
    wizard_config_set "idea" "$new"
  fi
  echo

  # Rider
  current="$(wizard_config_get rider)"
  echo "Path to JetBrains Rider (rider)"
  [[ -n "$current" ]] && echo "Current: $current"
  read -rp "> " new
  if [[ -n "$new" || -z "$current" ]]; then
    wizard_config_set "rider" "$new"
  fi
  echo

  # VS / VS Code
  current="$(wizard_config_get vs)"
  echo "Path to Visual Studio / VS Code (vs) (e.g. 'code' or full path)"
  [[ -n "$current" ]] && echo "Current: $current"
  read -rp "> " new
  if [[ -n "$new" || -z "$current" ]]; then
    wizard_config_set "vs" "$new"
  fi
  echo

  wizard_log "Configuration saved to $WIZARD_CONFIG"
}

dispatch_summon() {
  local target="$1"
  shift || true

  if [[ -z "$target" ]]; then
    wizard_log "ERROR: Missing summon target (idea|rider|vs)."
    exit 1
  fi

  local cmd="$WIZARD_COMMANDS/summon-$target"

  if [[ ! -x "$cmd" ]]; then
    wizard_log "ERROR: Unknown summon target: $target"
    wizard_log "Known targets: idea, rider, vs"
    exit 1
  fi

  "$cmd" "$@"
}

main() {
  local cmd="$1"
  shift || true

  case "$cmd" in
    ""|help)
      if [[ -n "$1" ]]; then
        show_command_help "$1"
      else
        show_help
      fi
      ;;
    version|-v|--version)
      echo "wizard $WIZARD_VERSION"
      ;;
    summon)
      dispatch_summon "$@"
      ;;
    configure)
      configure_interactive
      ;;
    config)
      case "$1" in
        list)
          wizard_config_list
          ;;
        *)
          wizard_fail "Usage: wizard config list"
          ;;
      esac
      ;;
    upgrade)
      bash "$WIZARD_HOME/upgrade.sh"
      ;;
    reinstall)
      bash "$WIZARD_HOME/reinstall.sh"
      ;;
    *)
      log "ERROR: Unknown command: $cmd"
      show_help
      exit 1
      ;;
  esac
}

main "$@"
